version: '3.8'
networks:
  tooling:
    driver: bridge
    ipam:
      config:
        - subnet: 172.16.11.0/24
  reverse-proxy: null

volumes:
  cicdtoolbox_db: null
  gitea:
    driver: local
  jenkins_certs: null
  jenkins_data: null
  jenkins_conf: null
  nexus_work: null
  nexus_db: null
  freeipa: null
  portainer_data: null
  sonarqube_data: null
  sonarqube_extensions: null
  sonarqube_logs: null
  sonarqube_temp: null

secrets:
  ca_crt:
    file: ./ca.crt
  keycloak_key:
    file: ./freeipa/certs/keycloak.tooling.test.key
  keycloak_crt:
    file: ./freeipa/certs/keycloak.tooling.test.pem
  jenkins_key:
    file: ./freeipa/certs/jenkins.tooling.test.key
  jenkins_crt:
    file: ./freeipa/certs/jenkins.tooling.test.pem
  nexus_key:
    file: ./freeipa/certs/nexus.tooling.test.key
  nexus_crt:
    file: ./freeipa/certs/nexus.tooling.test.pem

services:
  cicdtoolbox-db:
    container_name: cicdtoolbox-db.tooling.test
    build: cicdtoolbox-db
    command: >
      -c ssl=on 
      -c ssl_cert_file=/var/lib/postgresql/server.crt
      -c ssl_key_file=/var/lib/postgresql/server.key
    restart: unless-stopped
    init: true
    stop_signal: SIGINT
    stop_grace_period: 15s
    environment:
      - 'POSTGRES_MULTIPLE_DATABASES=gitea,keycloak,sonar'
      - POSTGRES_USER=netcicd
      - POSTGRES_PASSWORD=netcicd
    networks:
      tooling:
        ipv4_address: 172.16.11.2
    expose:
      - '5432'
    volumes:
      - 'cicdtoolbox_db:/var/lib/postgresql/data'

  gitea.tooling.test:
    container_name: gitea.tooling.test
    build: gitea
    restart: unless-stopped
    init: true
    stop_signal: SIGINT
    stop_grace_period: 15s
    environment:
      - USER_UID=1000
      - USER_GID=1000
      - GITEA__server__DOMAIN=gitea.tooling.test
      - GITEA__database__USER=gitea
      - GITEA__database__PASSWD=gitea
    secrets:
      - source: ca_crt
        target: /usr/local/share/ca-certificates/CICD-toolbox-ca.crt
    networks:
      tooling:
        ipv4_address: 172.16.11.3
    volumes:
      - 'gitea:/data'
      - '/etc/timezone:/etc/timezone:ro'
      - '/etc/localtime:/etc/localtime:ro'
    ports:
      - '3000:3000'
    depends_on:
      - cicdtoolbox-db
      - keycloak.tooling.test

  jenkins.tooling.test:
    container_name: jenkins.tooling.test
    build: ./jenkins
    restart: unless-stopped
    privileged: true
    user: root
    networks:
      tooling:
        ipv4_address: 172.16.11.8
    environment:
      - JENKINS_ADMIN_ID=local-admin
      - JENKINS_ADMIN_PASSWORD=netcicd
      - NETCICD_PASSWORD=netcicd
      - CML_USER=developer
      - CML_PASSWORD=C1sco12345
      - 'CML_URL=https://10.10.20.161'
      - GITEA_IP=172.16.11.3
      - JENKINS_IP=172.16.11.8
      - NEXUS_IP=172.16.11.9
      - JENKINS_JENKINS_PASSWORD=netcicd
      - JENKINS_NEXUS_PASSWORD=netcicd
      - JENKINS_ARGOS_PASSWORD=netcicd
    secrets:
      - source: jenkins_key
        target: /var/jenkins_home/jenkins.tooling.test.key
      - source: jenkins_crt
        target: /var/jenkins_home/jenkins.tooling.test.pem
    volumes:
      - 'jenkins_certs:/certs/client'
      - 'jenkins_data:/var/jenkins_home'
      - 'jenkins_conf:/var/jenkins_conf'
    ports:
      - '8084:8084'   
      - '50000:50000'
    depends_on:
      - keycloak.tooling.test

  nexus.tooling.test:
    container_name: nexus.tooling.test
    build: nexus
    restart: unless-stopped
    init: true
    stop_signal: SIGINT
    stop_grace_period: 15s
    user: nexus
    environment:
      BASE_URL: 'https://nexus.tooling.test:8443'
      NEXUS_SECURITY_RANDOMPASSWORD: 'true'
      NEXUS_CASC_CONFIG: /opt/nexus.yaml
    secrets:
      - source: ca_crt
        target: /nexus-data/etc/ssl/ca.crt
    volumes:
      - 'nexus_work:/sonatype-work'
      - 'nexus_db:/nexus-data'
    ulimits:
      nofile:
        soft: 65536
        hard: 65536
    networks:
      tooling:
        ipv4_address: 172.16.11.9
    ports:
      - '8081:8081'

  keycloak.tooling.test:
    container_name: keycloak.tooling.test
    build: keycloak
    restart: unless-stopped
    init: true
    stop_signal: SIGINT
    stop_grace_period: 15s
    environment:
      DB_VENDOR: POSTGRES
      DB_ADDR: cicdtoolbox-db
      DB_DATABASE: keycloak
      DB_USER: keycloak
      DB_SCHEMA: public
      DB_PASSWORD: keycloak
      KEYCLOAK_USER: local-admin
      KEYCLOAK_PASSWORD: Pa55w0rd
    secrets:
      - source: keycloak_key
        target: /etc/x509/https/tls.key
      - source: keycloak_crt
        target: /etc/x509/https/tls.crt
    networks:
      tooling:
        ipv4_address: 172.16.11.11
    ports:
      - '8080:8080'
      - '8443:8443'
    depends_on:
      - cicdtoolbox-db

  freeipa.tooling.test:
    container_name: freeipa.tooling.test
    build: freeipa
    restart: unless-stopped
    hostname: freeipa
    domainname: tooling.test
    volumes:
      - '/sys/fs/cgroup:/sys/fs/cgroup:ro'
      - 'freeipa:/data:Z'
    expose:
      - '80'
      - '443'
      - '389'
      - '636'
      - '88'
      - '464'
      - 88/udp
      - 464/udp
      - 123/udp
    environment:
      - IPA_SERVER_HOSTNAME=freeipa.tooling.test
      - IPA_SERVER_INSTALL_OPTS=-d -r tooling.test --ntp-pool=pool.ntp.org --domain=tooling.test --reverse-zone=16.172.in-addr.arpa -p Pa55w0rd -a Pa55w0rd --no-host-dns --setup-dns --no-forwarders --ip-address 172.16.11.12 --pki-config-override=/etc/pki/pki.conf -U
      - IPA_SERVER_IP=172.16.11.12
      - VIRTUAL_PROTO=http
      - VIRTUAL_HOST=freeipa.tooling.test
      - VIRTUAL_PORT=80
    dns:
      - 127.0.0.1
    sysctls:
      - net.ipv6.conf.all.disable_ipv6=0
    networks:
      tooling:
        ipv4_address: 172.16.11.12
      reverse-proxy: null
      
  portainer.tooling.test:
    container_name: portainer.tooling.test
    image: portainer/portainer-ce
    restart: unless-stopped
    init: true
    stop_signal: SIGINT
    stop_grace_period: 15s
    volumes:
      - 'portainer_data:/data'
      - '/var/run/docker.sock:/var/run/docker.sock'
    networks:
      tooling:
        ipv4_address: 172.16.11.15
    ports:
      - '9000:9000'
